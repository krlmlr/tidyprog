## Review of visualization and data transformation

<!-- Setup 01-intro.R -->
```{r 01-setup-01-intro-r}
library(tidyverse)
library(here)
```

We will be working with hourly measurements of weather data in four cities (Berlin, Toronto, Tel Aviv and Zurich) between 2019-04-28, 3pm and 2019-04-30, 3pm (Link to the data source documentation: https://darksky.net/dev/docs).
Thus we have 49 observations to deal with in each city.
The available variables are: `time`,	`summary` (how to describe the weather in one word),	`icon`	(mix of description of weather plus time of day), `precipIntensity` (intensity of precipitation),	`precipProbability`,	`temperature`,	`apparentTemperature`,	`dewPoint`,	`humidity`,	`pressure`,	`windSpeed`,	`windGust`,	`windBearing`,	`cloudCover`,	`uvIndex`,	`visibility`,	`ozone`,	`precipType`


<!-- Read all files -->
```{r 01-read-all-files}
berlin <- readxl::read_excel(here("data/weather", "berlin.xlsx"))
toronto <- readxl::read_excel(here("data/weather", "toronto.xlsx"))
tel_aviv <- readxl::read_excel(here("data/weather", "tel_aviv.xlsx"))
zurich <- readxl::read_excel(here("data/weather", "zurich.xlsx"))
```



<!-- Create ensemble dataset -->
```{r 01-create-ensemble-dataset}
weather_data <- bind_rows(
  berlin = berlin,
  toronto = toronto,
  tel_aviv = tel_aviv,
  zurich = zurich,
  .id = "city_code"
)
```


<!-- Visibility vs. humitidy -->
```{r 01-visibility-vs-humitidy}
weather_data %>%
  ggplot(aes(x = pressure, y = humidity, color = city_code)) +
  geom_path()
```


<!-- Summary -->
```{r 01-summary}
weather_data %>%
  ggplot(aes(x = city_code)) +
  geom_bar(aes(fill = summary))

weather_data %>%
  ggplot(aes(x = city_code)) +
  geom_bar(aes(fill = summary), position = position_dodge2("dodge", preserve = "single"))
```


<!-- Temperature and apparent temperature -->
```{r 01-temperature-and-apparent-temperature}
temperature_data <-
  weather_data %>%
  select(city_code, time, temperature, apparentTemperature) %>%
  gather(kind, temperature, -city_code, -time) %>%
  mutate(apparent = (kind == "apparentTemperature")) %>%
  select(-kind)

temperature_data %>%
  ggplot(aes(x = time, color = city_code)) +
  geom_linerange(data = weather_data, aes(ymin = temperature, ymax = apparentTemperature)) +
  geom_line(aes(linetype = apparent, y = temperature))
```


<!-- Compute and plot temperature difference -->
```{r 01-compute-and-plot-temperature-difference}
weather_data %>%
  mutate(apparentTemperatureReduction = temperature - apparentTemperature) %>%
  filter(city_code != "tel_aviv") %>%
  ggplot(aes(x = windSpeed, y = apparentTemperatureReduction)) +
  geom_point(aes(color = city_code))
```


<!-- Compute lag for temperature, pressure and humidity -->
```{r 01-compute-lag-for-temperature-pressure-and-humidity}
weather_data %>%
  group_by(city_code) %>%
  mutate_at(vars(temperature, pressure, humidity), list(lag = lag)) %>%
  ungroup()
```


<!-- How to compute temperature difference to previous hour? -->
```{r 01-how-to-compute-temperature-difference-to-previous-hour}

```


<!-- Count observations -->
```{r 01-count-observations}
weather_data %>%
  count(city_code)

weather_data %>%
  count(city_code, summary)
```


<!-- Compute mean and max temperature -->
```{r 01-compute-mean-and-max-temperature}
weather_data %>%
  group_by(city_code) %>%
  summarize(temperature_mean = mean(temperature), temperature_max = max(temperature)) %>%
  ungroup()
```


<!-- Compute and display summary data for all numeric variables -->
```{r 01-compute-and-display-summary-data-for-all-numeric-variables}
weather_data %>%
  group_by(city_code) %>%
  summarize_if(is.numeric, list(mean = mean, sd = sd, min = min, max = max)) %>%
  ungroup() %>%
  gather(key, value, -city_code) %>%
  separate(key, into = c("indicator", "fun")) %>%
  xtabs(value ~ city_code + indicator + fun, .) %>%
  ftable()
```
