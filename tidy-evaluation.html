<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>7 Tidy evaluation | Programming in the tidyverse</title>
  <meta name="description" content="7 Tidy evaluation | Programming in the tidyverse">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="7 Tidy evaluation | Programming in the tidyverse" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="7 Tidy evaluation | Programming in the tidyverse" />
  
  
  

<meta name="author" content="Kirill Müller, Tobias Schieferdecker">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="non-rectangular-data.html">
<link rel="next" href="best-practices.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="scroll.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#links"><i class="fa fa-check"></i>Links</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#package-versions-used"><i class="fa fa-check"></i>Package versions used</a></li>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i><b>0.1</b> License</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#overview"><i class="fa fa-check"></i><b>1.1</b> Overview</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#review-of-visualization-and-data-transformation"><i class="fa fa-check"></i><b>1.2</b> Review of visualization and data transformation</a><ul>
<li class="chapter" data-level="1.2.1" data-path="introduction.html"><a href="introduction.html#intro-data"><i class="fa fa-check"></i><b>1.2.1</b> Data</a></li>
<li class="chapter" data-level="1.2.2" data-path="introduction.html"><a href="introduction.html#exploration"><i class="fa fa-check"></i><b>1.2.2</b> Exploration</a></li>
<li class="chapter" data-level="1.2.3" data-path="introduction.html"><a href="introduction.html#further-dplyr-transformations"><i class="fa fa-check"></i><b>1.2.3</b> Further dplyr transformations</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="function-basics.html"><a href="function-basics.html"><i class="fa fa-check"></i><b>2</b> Function basics</a><ul>
<li class="chapter" data-level="2.1" data-path="function-basics.html"><a href="function-basics.html#definition-and-execution"><i class="fa fa-check"></i><b>2.1</b> Definition and execution</a><ul>
<li class="chapter" data-level="2.1.1" data-path="function-basics.html"><a href="function-basics.html#exercises"><i class="fa fa-check"></i><b>2.1.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="function-basics.html"><a href="function-basics.html#args"><i class="fa fa-check"></i><b>2.2</b> Arguments</a><ul>
<li class="chapter" data-level="2.2.1" data-path="function-basics.html"><a href="function-basics.html#exercises-1"><i class="fa fa-check"></i><b>2.2.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="function-basics.html"><a href="function-basics.html#intermediate"><i class="fa fa-check"></i><b>2.3</b> Use case: Intermediate variables</a><ul>
<li class="chapter" data-level="2.3.1" data-path="function-basics.html"><a href="function-basics.html#exercises-2"><i class="fa fa-check"></i><b>2.3.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="function-basics.html"><a href="function-basics.html#default-values"><i class="fa fa-check"></i><b>2.4</b> Default values</a><ul>
<li class="chapter" data-level="2.4.1" data-path="function-basics.html"><a href="function-basics.html#exercises-3"><i class="fa fa-check"></i><b>2.4.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="function-basics.html"><a href="function-basics.html#multiple-arguments"><i class="fa fa-check"></i><b>2.5</b> Multiple arguments</a><ul>
<li class="chapter" data-level="2.5.1" data-path="function-basics.html"><a href="function-basics.html#exercises-4"><i class="fa fa-check"></i><b>2.5.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="function-basics.html"><a href="function-basics.html#argument-matching"><i class="fa fa-check"></i><b>2.6</b> Argument matching</a><ul>
<li class="chapter" data-level="2.6.1" data-path="function-basics.html"><a href="function-basics.html#exercises-5"><i class="fa fa-check"></i><b>2.6.1</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="simple-iteration.html"><a href="simple-iteration.html"><i class="fa fa-check"></i><b>3</b> Simple iteration</a><ul>
<li class="chapter" data-level="3.1" data-path="simple-iteration.html"><a href="simple-iteration.html#vectors-and-columns"><i class="fa fa-check"></i><b>3.1</b> Vectors and columns</a><ul>
<li class="chapter" data-level="3.1.1" data-path="simple-iteration.html"><a href="simple-iteration.html#exercises-6"><i class="fa fa-check"></i><b>3.1.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="simple-iteration.html"><a href="simple-iteration.html#names"><i class="fa fa-check"></i><b>3.2</b> Named vectors and two-column tibbles</a><ul>
<li class="chapter" data-level="3.2.1" data-path="simple-iteration.html"><a href="simple-iteration.html#exercises-7"><i class="fa fa-check"></i><b>3.2.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="simple-iteration.html"><a href="simple-iteration.html#indexing"><i class="fa fa-check"></i><b>3.3</b> Indexing/subsetting</a><ul>
<li class="chapter" data-level="3.3.1" data-path="simple-iteration.html"><a href="simple-iteration.html#exercises-8"><i class="fa fa-check"></i><b>3.3.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="simple-iteration.html"><a href="simple-iteration.html#construction"><i class="fa fa-check"></i><b>3.4</b> Construction</a><ul>
<li class="chapter" data-level="3.4.1" data-path="simple-iteration.html"><a href="simple-iteration.html#exercises-9"><i class="fa fa-check"></i><b>3.4.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="simple-iteration.html"><a href="simple-iteration.html#map"><i class="fa fa-check"></i><b>3.5</b> Processing multiple files</a><ul>
<li class="chapter" data-level="3.5.1" data-path="simple-iteration.html"><a href="simple-iteration.html#exercises-10"><i class="fa fa-check"></i><b>3.5.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="simple-iteration.html"><a href="simple-iteration.html#map_manip"><i class="fa fa-check"></i><b>3.6</b> Manipulating all datasets</a><ul>
<li class="chapter" data-level="3.6.1" data-path="simple-iteration.html"><a href="simple-iteration.html#exercises-11"><i class="fa fa-check"></i><b>3.6.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="simple-iteration.html"><a href="simple-iteration.html#typed-output"><i class="fa fa-check"></i><b>3.7</b> Typed output</a><ul>
<li class="chapter" data-level="3.7.1" data-path="simple-iteration.html"><a href="simple-iteration.html#exercises-12"><i class="fa fa-check"></i><b>3.7.1</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="pairwise-iteration-and-nesting.html"><a href="pairwise-iteration-and-nesting.html"><i class="fa fa-check"></i><b>4</b> Pairwise iteration and nesting</a><ul>
<li class="chapter" data-level="4.1" data-path="pairwise-iteration-and-nesting.html"><a href="pairwise-iteration-and-nesting.html#manipulating-pairwise"><i class="fa fa-check"></i><b>4.1</b> Manipulating pairwise</a><ul>
<li class="chapter" data-level="4.1.1" data-path="pairwise-iteration-and-nesting.html"><a href="pairwise-iteration-and-nesting.html#exercises-13"><i class="fa fa-check"></i><b>4.1.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="pairwise-iteration-and-nesting.html"><a href="pairwise-iteration-and-nesting.html#mut_map"><i class="fa fa-check"></i><b>4.2</b> Moving to tibble-land</a><ul>
<li class="chapter" data-level="4.2.1" data-path="pairwise-iteration-and-nesting.html"><a href="pairwise-iteration-and-nesting.html#exercises-14"><i class="fa fa-check"></i><b>4.2.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="pairwise-iteration-and-nesting.html"><a href="pairwise-iteration-and-nesting.html#nest"><i class="fa fa-check"></i><b>4.3</b> Nesting and unnesting</a><ul>
<li class="chapter" data-level="4.3.1" data-path="pairwise-iteration-and-nesting.html"><a href="pairwise-iteration-and-nesting.html#exercises-15"><i class="fa fa-check"></i><b>4.3.1</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="scoping-and-flow-control.html"><a href="scoping-and-flow-control.html"><i class="fa fa-check"></i><b>5</b> Scoping and flow control</a><ul>
<li class="chapter" data-level="5.1" data-path="scoping-and-flow-control.html"><a href="scoping-and-flow-control.html#scope"><i class="fa fa-check"></i><b>5.1</b> Scope</a><ul>
<li class="chapter" data-level="5.1.1" data-path="scoping-and-flow-control.html"><a href="scoping-and-flow-control.html#exercises-16"><i class="fa fa-check"></i><b>5.1.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="scoping-and-flow-control.html"><a href="scoping-and-flow-control.html#pure-functions-and-side-effects"><i class="fa fa-check"></i><b>5.2</b> Pure functions and side effects</a><ul>
<li class="chapter" data-level="5.2.1" data-path="scoping-and-flow-control.html"><a href="scoping-and-flow-control.html#exercises-17"><i class="fa fa-check"></i><b>5.2.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="scoping-and-flow-control.html"><a href="scoping-and-flow-control.html#control-flow"><i class="fa fa-check"></i><b>5.3</b> Control flow</a><ul>
<li class="chapter" data-level="5.3.1" data-path="scoping-and-flow-control.html"><a href="scoping-and-flow-control.html#exercises-18"><i class="fa fa-check"></i><b>5.3.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="scoping-and-flow-control.html"><a href="scoping-and-flow-control.html#closures"><i class="fa fa-check"></i><b>5.4</b> Closures</a><ul>
<li class="chapter" data-level="5.4.1" data-path="scoping-and-flow-control.html"><a href="scoping-and-flow-control.html#exercises-19"><i class="fa fa-check"></i><b>5.4.1</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="non-rectangular-data.html"><a href="non-rectangular-data.html"><i class="fa fa-check"></i><b>6</b> Non-rectangular data</a><ul>
<li class="chapter" data-level="6.1" data-path="non-rectangular-data.html"><a href="non-rectangular-data.html#berlin"><i class="fa fa-check"></i><b>6.1</b> Traversing</a><ul>
<li class="chapter" data-level="6.1.1" data-path="non-rectangular-data.html"><a href="non-rectangular-data.html#exercises-20"><i class="fa fa-check"></i><b>6.1.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="non-rectangular-data.html"><a href="non-rectangular-data.html#komoot"><i class="fa fa-check"></i><b>6.2</b> Iterating and traversing</a><ul>
<li class="chapter" data-level="6.2.1" data-path="non-rectangular-data.html"><a href="non-rectangular-data.html#exercises-21"><i class="fa fa-check"></i><b>6.2.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="non-rectangular-data.html"><a href="non-rectangular-data.html#multipluck"><i class="fa fa-check"></i><b>6.3</b> Plucking multiple locations</a></li>
<li class="chapter" data-level="6.4" data-path="non-rectangular-data.html"><a href="non-rectangular-data.html#flatten"><i class="fa fa-check"></i><b>6.4</b> Flattening</a></li>
<li class="chapter" data-level="6.5" data-path="non-rectangular-data.html"><a href="non-rectangular-data.html#transpose"><i class="fa fa-check"></i><b>6.5</b> Transposing</a><ul>
<li class="chapter" data-level="6.5.1" data-path="non-rectangular-data.html"><a href="non-rectangular-data.html#exercises-22"><i class="fa fa-check"></i><b>6.5.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="non-rectangular-data.html"><a href="non-rectangular-data.html#rectangulate"><i class="fa fa-check"></i><b>6.6</b> Rectangling</a></li>
<li class="chapter" data-level="6.7" data-path="non-rectangular-data.html"><a href="non-rectangular-data.html#accessing-apis"><i class="fa fa-check"></i><b>6.7</b> Accessing APIs</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="tidy-evaluation.html"><a href="tidy-evaluation.html"><i class="fa fa-check"></i><b>7</b> Tidy evaluation</a><ul>
<li class="chapter" data-level="7.1" data-path="tidy-evaluation.html"><a href="tidy-evaluation.html#colname"><i class="fa fa-check"></i><b>7.1</b> A custom plotting function</a></li>
<li class="chapter" data-level="7.2" data-path="tidy-evaluation.html"><a href="tidy-evaluation.html#do-you-need-tidy-evaluation"><i class="fa fa-check"></i><b>7.2</b> Do you need tidy evaluation?</a></li>
<li class="chapter" data-level="7.3" data-path="tidy-evaluation.html"><a href="tidy-evaluation.html#explicit-quote-unquote-of-ellipsis"><i class="fa fa-check"></i><b>7.3</b> Explicit quote-unquote of ellipsis</a></li>
<li class="chapter" data-level="7.4" data-path="tidy-evaluation.html"><a href="tidy-evaluation.html#named"><i class="fa fa-check"></i><b>7.4</b> Names</a></li>
<li class="chapter" data-level="7.5" data-path="tidy-evaluation.html"><a href="tidy-evaluation.html#debugging"><i class="fa fa-check"></i><b>7.5</b> Debugging</a></li>
<li class="chapter" data-level="7.6" data-path="tidy-evaluation.html"><a href="tidy-evaluation.html#argnames"><i class="fa fa-check"></i><b>7.6</b> Argument names</a></li>
<li class="chapter" data-level="7.7" data-path="tidy-evaluation.html"><a href="tidy-evaluation.html#purrr-style-mappers"><i class="fa fa-check"></i><b>7.7</b> purrr-style mappers</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="best-practices.html"><a href="best-practices.html"><i class="fa fa-check"></i><b>8</b> Best practices</a><ul>
<li class="chapter" data-level="8.1" data-path="best-practices.html"><a href="best-practices.html#description"><i class="fa fa-check"></i><b>8.1</b> DESCRIPTION</a></li>
<li class="chapter" data-level="8.2" data-path="best-practices.html"><a href="best-practices.html#r"><i class="fa fa-check"></i><b>8.2</b> R</a></li>
<li class="chapter" data-level="8.3" data-path="best-practices.html"><a href="best-practices.html#roxygen2"><i class="fa fa-check"></i><b>8.3</b> roxygen2</a></li>
<li class="chapter" data-level="8.4" data-path="best-practices.html"><a href="best-practices.html#testthat"><i class="fa fa-check"></i><b>8.4</b> testthat</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i># References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Programming in the tidyverse</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="tidy-evaluation" class="section level1">
<h1><span class="header-section-number">7</span> Tidy evaluation</h1>
<blockquote>
<p>writing functions that work with datasets of different shape</p>
</blockquote>
<p>This chapter offers an introduction to tidy evaluation.</p>
<div id="colname" class="section level2">
<h2><span class="header-section-number">7.1</span> A custom plotting function</h2>
<details>
<p><summary><em>Click here to show setup code.</em></summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(rlang)</code></pre>
</details>
<p>Knowledge of tidy evaluation can become necessary when creating own functions in the framework of the tidyverse.</p>
<p>Let’s try to build a function that takes a data frame and an unquoted column name and produces a histogram from this column.
A naive approach would be the following function definition:</p>
<pre class="sourceCode r"><code class="sourceCode r">tidy_histogram &lt;-<span class="st"> </span><span class="cf">function</span>(.data, x) {
  .data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_histogram</span>()
}</code></pre>
<p>Let’s test this function in an easy setting:</p>
<pre class="sourceCode r"><code class="sourceCode r">data &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">a =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)

<span class="kw">try</span>(<span class="kw">print</span>(
  data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">tidy_histogram</span>(a)
))</code></pre>
<pre><code>## Error in FUN(X[[i]], ...) : object &#39;a&#39; not found</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">try</span>(<span class="kw">print</span>(
  data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">tidy_histogram</span>(<span class="st">&quot;a&quot;</span>)
))</code></pre>
<p><img src="tidyprog_files/figure-html/71-would-that-work-1.png" width="672" /></p>
<pre><code>## Error : StatBin requires a continuous x variable: the x variable is discrete. Perhaps you want stat=&quot;count&quot;?</code></pre>
<p>Neither the first nor the second attempt worked. What went wrong?</p>
<p>If we add another column called <code>x</code>, it suddenly works:</p>
<pre class="sourceCode r"><code class="sourceCode r">data &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">a =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">x =</span> <span class="dv">11</span><span class="op">:</span><span class="dv">20</span>)

data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tidy_histogram</span>(a)</code></pre>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="tidyprog_files/figure-html/71-no-the-function-is-looking-for-a-variable-named-x-1.png" width="672" /></p>
<p>The reason for it is, that our function is hard-coded to display a variable called <code>x</code>.
The problem lies in the code-snippet <code>aes(x = x)</code>.</p>
<p>In the tidyverse the solution for avoiding these ambiguities is by using expressions to capture the meaning (here: user input) of an unquoted variable and subsequently the bang-bang-operator (written in the code as <code>!!</code>; also called “unquote”) to access/pass on this meaning at the right place.</p>
<p>In our example we do the following:</p>
<pre class="sourceCode r"><code class="sourceCode r">tidy_histogram &lt;-<span class="st"> </span><span class="cf">function</span>(.data, x) {
  <span class="co"># Treat the argument as a variable name</span>
  expr &lt;-<span class="st"> </span><span class="kw">enquo</span>(x)

  .data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="co"># Tell ggplot2 that expr *contains* the name of the variable,</span>
<span class="st">    </span><span class="co"># instead of expecting a variable named `expr`</span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="op">!!</span>expr)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_histogram</span>()
}

data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tidy_histogram</span>(a)</code></pre>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="tidyprog_files/figure-html/71-solution-quote-unquote-1.png" width="672" /></p>
<pre class="sourceCode r"><code class="sourceCode r">data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tidy_histogram</span>(x)</code></pre>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="tidyprog_files/figure-html/71-solution-quote-unquote-2.png" width="672" /></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">try</span>(<span class="kw">print</span>(
  data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">tidy_histogram</span>(y)
))</code></pre>
<p><img src="tidyprog_files/figure-html/71-solution-quote-unquote-3.png" width="672" /></p>
<pre><code>## Error in FUN(X[[i]], ...) : object &#39;y&#39; not found</code></pre>
<p>But this behavior is different from our usual base-R usage of variables in functions.
How do some functions behave this way and others another way?
Let’s have a look at how the ‘problematic’ tidyverse function <code>aes()</code> is implemented:</p>
<pre class="sourceCode r"><code class="sourceCode r">aes</code></pre>
<pre><code>## function (x, y, ...) 
## {
##     exprs &lt;- rlang::enquos(x = x, y = y, ...)
##     is_missing &lt;- vapply(exprs, rlang::quo_is_missing, logical(1))
##     aes &lt;- new_aes(exprs[!is_missing], env = parent.frame())
##     rename_aes(aes)
## }
## &lt;bytecode: 0x47e7ca8&gt;
## &lt;environment: namespace:ggplot2&gt;</code></pre>
<p>The reason for the behavior seen above is that the function itself makes use of capturing user input as an expression.
In this case it uses the function <code>enquos()</code>, which captures one or more expressions along with an unique identifier for the environment in which they are supposed to be evaluated eventually.
The default is to evaluate an expression (“standard evaluation”).
With <code>enquo()</code> and <code>enquos()</code> the expressions that correspond to user input are captured.</p>
<p>As an example of a newly-built function in the tidyverse, here is a function that combines the functionalities of <code>dplyr::mutate()</code> and <code>purrr::map_dbl()</code>.
It takes as arguments a data frame, the column it is supposed to act upon and the function call it is supposed to use on each of the columns values:</p>
<pre class="sourceCode r"><code class="sourceCode r">mutate_map_dbl &lt;-<span class="st"> </span><span class="cf">function</span>(.data, col, expr) {
  quo &lt;-<span class="st"> </span><span class="kw">enquo</span>(col)

  .data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">new_column =</span> <span class="kw">map_dbl</span>(<span class="op">!!</span>quo, expr))
}

iris_nested &lt;-
<span class="st">  </span>iris <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>Species)

iris_nested <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_map_dbl</span>(data, <span class="op">~</span><span class="st"> </span><span class="kw">mean</span>(.<span class="op">$</span>Petal.Width))</code></pre>
<PRE class="fansi fansi-output"><CODE>## <span style='color: #555555;'># A tibble: 3 x 3</span><span>
##   </span><span style='font-weight: bold;'>Species</span><span>    </span><span style='font-weight: bold;'>data</span><span>              </span><span style='font-weight: bold;'>new_column</span><span>
##   </span><span style='color: #555555;font-style: italic;'>&lt;fct&gt;</span><span>      </span><span style='color: #555555;font-style: italic;'>&lt;list&gt;</span><span>                 </span><span style='color: #555555;font-style: italic;'>&lt;dbl&gt;</span><span>
## </span><span style='color: #555555;'>1</span><span> setosa     </span><span style='color: #555555;'>&lt;tibble [50 × 4]&gt;</span><span>      0.246
## </span><span style='color: #555555;'>2</span><span> versicolor </span><span style='color: #555555;'>&lt;tibble [50 × 4]&gt;</span><span>      1.33 
## </span><span style='color: #555555;'>3</span><span> virginica  </span><span style='color: #555555;'>&lt;tibble [50 × 4]&gt;</span><span>      2.03
</span></CODE></PRE>
</div>
<div id="do-you-need-tidy-evaluation" class="section level2">
<h2><span class="header-section-number">7.2</span> Do you need tidy evaluation?</h2>
<details>
<p><summary><em>Click here to show setup code.</em></summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)</code></pre>
</details>
<p>So does everyone who wants to create any functions in the framework of the tidyverse need deep knowledge about tidy evaluation?</p>
<p>The answer is, it depends: often enough, things “just work”.
In the following example, which is a slight extension of <code>dplyr::summarize()</code>, you do not need to capture any expressions.
The function takes a data frame and an ellipsis.
And the ellipsis can be directly passed on to a tidyverse function (buzzphrase: “pass the dots”).</p>
<pre class="sourceCode r"><code class="sourceCode r">summarize_ungroup &lt;-<span class="st"> </span><span class="cf">function</span>(.data, ...) {
  .data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">summarize</span>(...) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ungroup</span>()
}</code></pre>
<p>The function does what it promised to do:</p>
<pre class="sourceCode r"><code class="sourceCode r">mean_airtime_per_day &lt;-
<span class="st">  </span>nycflights13<span class="op">::</span>flights <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(year, month, day) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize_ungroup</span>(<span class="kw">mean</span>(air_time, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))

mean_airtime_per_day</code></pre>
<PRE class="fansi fansi-output"><CODE>## <span style='color: #555555;'># A tibble: 365 x 4</span><span>
##    </span><span style='font-weight: bold;'>year</span><span> </span><span style='font-weight: bold;'>month</span><span>   </span><span style='font-weight: bold;'>day</span><span> </span><span style='font-weight: bold;'>`mean(air_time, na.rm = TRUE)`</span><span>
##   </span><span style='color: #555555;font-style: italic;'>&lt;int&gt;</span><span> </span><span style='color: #555555;font-style: italic;'>&lt;int&gt;</span><span> </span><span style='color: #555555;font-style: italic;'>&lt;int&gt;</span><span>                          </span><span style='color: #555555;font-style: italic;'>&lt;dbl&gt;</span><span>
## </span><span style='color: #555555;'>1</span><span>  </span><span style='text-decoration: underline;'>2</span><span>013     1     1                           170.
## </span><span style='color: #555555;'>2</span><span>  </span><span style='text-decoration: underline;'>2</span><span>013     1     2                           162.
## </span><span style='color: #555555;'>3</span><span>  </span><span style='text-decoration: underline;'>2</span><span>013     1     3                           157.
## </span><span style='color: #555555;'># … with 362 more rows</span><span>
</span></CODE></PRE>
<pre class="sourceCode r"><code class="sourceCode r">mean_airtime_per_day <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">groups</span>()</code></pre>
<pre><code>## NULL</code></pre>
</div>
<div id="explicit-quote-unquote-of-ellipsis" class="section level2">
<h2><span class="header-section-number">7.3</span> Explicit quote-unquote of ellipsis</h2>
<details>
<p><summary><em>Click here to show setup code.</em></summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(rlang)</code></pre>
</details>
<p>There are cases though, when you need knowledge about what the user added to the ellipsis.
This is then handled by capturing the content in a list of quosures, which can be unquoted by the <code>!!!</code>-operator.
You need the “triple-bang” operator here, because the ellipsis can hold more than one expression.
<code>!!!</code> does two things: it unquotes the content and splices it into the current call.</p>
<p>We can practice this with our little new tidyverse function <code>summarize_ungroup()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">summarize_ungroup &lt;-<span class="st"> </span><span class="cf">function</span>(.data, ...) {
  <span class="co"># Capture (quote) with enquos()</span>
  quos &lt;-<span class="st"> </span><span class="kw">enquos</span>(...)

  <span class="co"># Use (unquote-splice) with !!!</span>
  .data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">summarize</span>(<span class="op">!!!</span>quos) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ungroup</span>()
}</code></pre>
<p>We didn’t need to process the content, but it still works, as we can see here:</p>
<pre class="sourceCode r"><code class="sourceCode r">mean_airtime_per_day &lt;-
<span class="st">  </span>nycflights13<span class="op">::</span>flights <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(year, month, day) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize_ungroup</span>(<span class="kw">mean</span>(air_time, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))

mean_airtime_per_day</code></pre>
<PRE class="fansi fansi-output"><CODE>## <span style='color: #555555;'># A tibble: 365 x 4</span><span>
##    </span><span style='font-weight: bold;'>year</span><span> </span><span style='font-weight: bold;'>month</span><span>   </span><span style='font-weight: bold;'>day</span><span> </span><span style='font-weight: bold;'>`mean(air_time, na.rm = TRUE)`</span><span>
##   </span><span style='color: #555555;font-style: italic;'>&lt;int&gt;</span><span> </span><span style='color: #555555;font-style: italic;'>&lt;int&gt;</span><span> </span><span style='color: #555555;font-style: italic;'>&lt;int&gt;</span><span>                          </span><span style='color: #555555;font-style: italic;'>&lt;dbl&gt;</span><span>
## </span><span style='color: #555555;'>1</span><span>  </span><span style='text-decoration: underline;'>2</span><span>013     1     1                           170.
## </span><span style='color: #555555;'>2</span><span>  </span><span style='text-decoration: underline;'>2</span><span>013     1     2                           162.
## </span><span style='color: #555555;'>3</span><span>  </span><span style='text-decoration: underline;'>2</span><span>013     1     3                           157.
## </span><span style='color: #555555;'># … with 362 more rows</span><span>
</span></CODE></PRE>
<pre class="sourceCode r"><code class="sourceCode r">mean_airtime_per_day <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">groups</span>()</code></pre>
<pre><code>## NULL</code></pre>
<p>To come back to our original example: <code>aes()</code> uses exactly this “quote-unquote-splice”-pattern:</p>
<pre class="sourceCode r"><code class="sourceCode r">aes</code></pre>
<pre><code>## function (x, y, ...) 
## {
##     exprs &lt;- rlang::enquos(x = x, y = y, ...)
##     is_missing &lt;- vapply(exprs, rlang::quo_is_missing, logical(1))
##     aes &lt;- new_aes(exprs[!is_missing], env = parent.frame())
##     rename_aes(aes)
## }
## &lt;bytecode: 0x47e7ca8&gt;
## &lt;environment: namespace:ggplot2&gt;</code></pre>
<p>At the time of producing the material for this course, <code>summarize()</code> did not make use of this pattern.</p>
</div>
<div id="named" class="section level2">
<h2><span class="header-section-number">7.4</span> Names</h2>
<details>
<p><summary><em>Click here to show setup code.</em></summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(rlang)</code></pre>
</details>
<p>User input in an ellipsis can be named or unnamed.
We can distinguish between those two kinds and make use of this distinction, in the following way creating a special interface for the function:</p>
<pre class="sourceCode r"><code class="sourceCode r">gsu &lt;-<span class="st"> </span><span class="cf">function</span>(.data, ...) {
  <span class="co"># Capture (quote) with enquos()</span>
  quos &lt;-<span class="st"> </span><span class="kw">enquos</span>(...)

  is_named &lt;-<span class="st"> </span>(<span class="kw">names2</span>(quos) <span class="op">!=</span><span class="st"> &quot;&quot;</span>)
  named_quos &lt;-<span class="st"> </span>quos[is_named]
  unnamed_quos &lt;-<span class="st"> </span>quos[<span class="op">!</span>is_named]

  <span class="co"># Use (unquote-splice) with !!!</span>
  .data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(<span class="op">!!!</span>unnamed_quos) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">summarize</span>(<span class="op">!!!</span>named_quos) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ungroup</span>()
}</code></pre>
<p>The <code>named_quos</code> are our summary columns (name is name of the new column, value is the expression to be used on the input column(s)) and the <code>unnamed_quos</code> are now the grouping columns:</p>
<pre class="sourceCode r"><code class="sourceCode r">mean_airtime_per_day &lt;-
<span class="st">  </span>nycflights13<span class="op">::</span>flights <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">gsu</span>(year, month, day, <span class="dt">mean_air_time =</span> <span class="kw">mean</span>(air_time, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))

mean_airtime_per_day</code></pre>
<PRE class="fansi fansi-output"><CODE>## <span style='color: #555555;'># A tibble: 365 x 4</span><span>
##    </span><span style='font-weight: bold;'>year</span><span> </span><span style='font-weight: bold;'>month</span><span>   </span><span style='font-weight: bold;'>day</span><span> </span><span style='font-weight: bold;'>mean_air_time</span><span>
##   </span><span style='color: #555555;font-style: italic;'>&lt;int&gt;</span><span> </span><span style='color: #555555;font-style: italic;'>&lt;int&gt;</span><span> </span><span style='color: #555555;font-style: italic;'>&lt;int&gt;</span><span>         </span><span style='color: #555555;font-style: italic;'>&lt;dbl&gt;</span><span>
## </span><span style='color: #555555;'>1</span><span>  </span><span style='text-decoration: underline;'>2</span><span>013     1     1          170.
## </span><span style='color: #555555;'>2</span><span>  </span><span style='text-decoration: underline;'>2</span><span>013     1     2          162.
## </span><span style='color: #555555;'>3</span><span>  </span><span style='text-decoration: underline;'>2</span><span>013     1     3          157.
## </span><span style='color: #555555;'># … with 362 more rows</span><span>
</span></CODE></PRE>
</div>
<div id="debugging" class="section level2">
<h2><span class="header-section-number">7.5</span> Debugging</h2>
<details>
<p><summary><em>Click here to show setup code.</em></summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rlang)</code></pre>
</details>
<p>You can use the capturing functions (creating <code>quosures</code> or <code>expressions</code>) also outside of functions:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">quos</span>(<span class="dt">x =</span> a)</code></pre>
<PRE class="fansi fansi-output"><CODE>## $x
## <span style='font-weight: bold;'>&lt;quosure&gt;</span><span>
## expr: </span><span style='color: #0000BB;'>^a</span><span>
## env:  </span><span style='color: #0000BB;'>0x2f0dc30</span><span>
</span></CODE></PRE>
<pre class="sourceCode r"><code class="sourceCode r">a &lt;-<span class="st"> </span><span class="kw">sym</span>(<span class="st">&quot;b&quot;</span>)
x_quos &lt;-<span class="st"> </span><span class="kw">quos</span>(<span class="dt">x =</span> <span class="op">!!</span>a)
x_quos</code></pre>
<PRE class="fansi fansi-output"><CODE>## $x
## <span style='font-weight: bold;'>&lt;quosure&gt;</span><span>
## expr: </span><span style='color: #0000BB;'>^b</span><span>
## env:  </span><span style='color: #0000BB;'>0x2f0dc30</span><span>
</span></CODE></PRE>
<p>The <code>sym()</code> function here creates a so-called <code>symbol</code> from a <code>character</code> variable.
Unquoting a symbol variable means that the symbol is interpreted as a variable in the dataset.</p>
<p>Capturing expressions in quosures can help you understand what is happening behind the scenes and for example give you clues as to why your code is not doing what it is supposed to do.</p>
<p>Quosures can also be nested:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">quos</span>(<span class="dt">y =</span> c, <span class="op">!!!</span>x_quos)</code></pre>
<PRE class="fansi fansi-output"><CODE>## $y
## <span style='font-weight: bold;'>&lt;quosure&gt;</span><span>
## expr: </span><span style='color: #0000BB;'>^c</span><span>
## env:  </span><span style='color: #0000BB;'>0x2f0dc30</span><span>
## 
## $x
## </span><span style='font-weight: bold;'>&lt;quosure&gt;</span><span>
## expr: </span><span style='color: #0000BB;'>^b</span><span>
## env:  </span><span style='color: #0000BB;'>0x2f0dc30</span><span>
</span></CODE></PRE>
</div>
<div id="argnames" class="section level2">
<h2><span class="header-section-number">7.6</span> Argument names</h2>
<details>
<p><summary><em>Click here to show setup code.</em></summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(rlang)</code></pre>
</details>
<p>At the end of section <a href="tidy-evaluation.html#colname">A custom plotting function</a> we defined a function <code>mutate_map_dbl()</code>.
A downside of this function was, that it did create the desired new column, but you weren’t able to specify the column name in the function call.</p>
<p>Let’s try to improve this aspect of the function:</p>
<pre class="sourceCode r"><code class="sourceCode r">mutate_map_dbl &lt;-<span class="st"> </span><span class="cf">function</span>(.data, col, ...) {
  quos &lt;-<span class="st"> </span><span class="kw">build_quos</span>(<span class="op">!!</span><span class="kw">enquo</span>(col), ...)
  .data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="op">!!!</span>quos)
}

build_quos &lt;-<span class="st"> </span><span class="cf">function</span>(col, ...) {
  args &lt;-<span class="st"> </span><span class="kw">list</span>(...)
  <span class="kw">stopifnot</span>(<span class="kw">length</span>(args) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)

  expr &lt;-<span class="st"> </span>args[[<span class="dv">1</span>]]

  map_quo &lt;-<span class="st"> </span><span class="kw">build_map_quo</span>(<span class="op">!!</span><span class="kw">enquo</span>(col), expr)

  <span class="kw">set_names</span>(<span class="kw">list</span>(map_quo), <span class="kw">names</span>(args))
}

build_map_quo &lt;-<span class="st"> </span><span class="cf">function</span>(col, expr) {
  quo &lt;-<span class="st"> </span><span class="kw">enquo</span>(col)
  <span class="kw">quo</span>(<span class="kw">map_dbl</span>(<span class="op">!!</span>quo, expr))
}</code></pre>
<p>Again, like in section <a href="tidy-evaluation.html#named">Names</a> we are able to make use of the fact that an expression in an ellipsis of sorts <code>x = y</code> is treated in a way, that <code>x</code> is the name and <code>y</code> is the value of an object (here we used this in the code snippet <code>names(args)</code>).</p>
<p>A lot of things happen here:
1. the main function <code>mutate_map_dbl()</code> calls a helper function <code>build_quos()</code>
2. <code>build_quos()</code> in turn calls a helper’s helper function <code>build_map_quo()</code>
3. <code>mutate_map_dbl()</code> then uses the output of the nested function calls to (hopefully) produce the desired result.</p>
<p>What output do the two helper functions produce? Let’s test it:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">build_quos</span>(data, <span class="dt">mean_petal_width =</span> <span class="op">~</span><span class="st"> </span><span class="kw">mean</span>(.<span class="op">$</span>Petal.Width))</code></pre>
<PRE class="fansi fansi-output"><CODE>## $mean_petal_width
## <span style='font-weight: bold;'>&lt;quosure&gt;</span><span>
## expr: </span><span style='color: #0000BB;'>^map_dbl(</span><span style='color: #00BB00;'>^data</span><span style='color: #0000BB;'>, expr)</span><span>
## env:  </span><span style='color: #0000BB;'>0xa0aeda0</span><span>
</span></CODE></PRE>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">build_map_quo</span>(mean_petal_width, <span class="op">~</span><span class="st"> </span><span class="kw">mean</span>(.<span class="op">$</span>Petal.Width))</code></pre>
<PRE class="fansi fansi-output"><CODE>## <span style='font-weight: bold;'>&lt;quosure&gt;</span><span>
## expr: </span><span style='color: #0000BB;'>^map_dbl(</span><span style='color: #00BB00;'>^mean_petal_width</span><span style='color: #0000BB;'>, expr)</span><span>
## env:  </span><span style='color: #0000BB;'>0x9635558</span><span>
</span></CODE></PRE>
<p>And finally, let’s see if our function lives up to our expectations:</p>
<pre class="sourceCode r"><code class="sourceCode r">iris <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>Species) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_map_dbl</span>(data, <span class="dt">mean_petal_width =</span> <span class="op">~</span><span class="st"> </span><span class="kw">mean</span>(.<span class="op">$</span>Petal.Width))</code></pre>
<PRE class="fansi fansi-output"><CODE>## <span style='color: #555555;'># A tibble: 3 x 3</span><span>
##   </span><span style='font-weight: bold;'>Species</span><span>    </span><span style='font-weight: bold;'>data</span><span>              </span><span style='font-weight: bold;'>mean_petal_width</span><span>
##   </span><span style='color: #555555;font-style: italic;'>&lt;fct&gt;</span><span>      </span><span style='color: #555555;font-style: italic;'>&lt;list&gt;</span><span>                       </span><span style='color: #555555;font-style: italic;'>&lt;dbl&gt;</span><span>
## </span><span style='color: #555555;'>1</span><span> setosa     </span><span style='color: #555555;'>&lt;tibble [50 × 4]&gt;</span><span>            0.246
## </span><span style='color: #555555;'>2</span><span> versicolor </span><span style='color: #555555;'>&lt;tibble [50 × 4]&gt;</span><span>            1.33 
## </span><span style='color: #555555;'>3</span><span> virginica  </span><span style='color: #555555;'>&lt;tibble [50 × 4]&gt;</span><span>            2.03
</span></CODE></PRE>
<!-- Now go and try to do this in base R :) -->
</div>
<div id="purrr-style-mappers" class="section level2">
<h2><span class="header-section-number">7.7</span> purrr-style mappers</h2>
<details>
<p><summary><em>Click here to show setup code.</em></summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(rlang)

mutate_map_dbl &lt;-<span class="st"> </span><span class="cf">function</span>(.data, col, ...) {
  quos &lt;-<span class="st"> </span><span class="kw">build_quos</span>(<span class="op">!!</span><span class="kw">enquo</span>(col), ...)
  .data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="op">!!!</span>quos)
}</code></pre>
</details>
<p>Is there still potential to improve our function <code>mutate_map_dbl()</code>?</p>
<p>We start here with only the highest level function definition of <code>mutate_map_dbl()</code> from section <a href="tidy-evaluation.html#argnames">Argument names</a>, i.e. without the definition of its helper functions <code>build_quos()</code> and <code>build_map_quo()</code>.</p>
<p>What we are trying to achieve now, is to rid ourselves from the need to provide the tilde before the function.
This is a slightly more tricky task, and here is how to go about it:</p>
<pre class="sourceCode r"><code class="sourceCode r">build_quos &lt;-<span class="st"> </span><span class="cf">function</span>(col, ...) {
  args &lt;-<span class="st"> </span><span class="kw">enquos</span>(...)
  <span class="kw">stopifnot</span>(<span class="kw">length</span>(args) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)

  expr &lt;-<span class="st"> </span>args[[<span class="dv">1</span>]]

  map_quo &lt;-<span class="st"> </span><span class="kw">build_map_quo</span>(<span class="op">!!</span><span class="kw">enquo</span>(col), <span class="op">!!</span>expr)

  <span class="kw">set_names</span>(<span class="kw">list</span>(map_quo), <span class="kw">names</span>(args))
}

build_map_quo &lt;-<span class="st"> </span><span class="cf">function</span>(col, expr) {
  quo &lt;-<span class="st"> </span><span class="kw">enquo</span>(col)
  mapper &lt;-<span class="st"> </span><span class="kw">as_mapper_quosure</span>(<span class="op">!!</span><span class="kw">enquo</span>(expr))
  <span class="kw">quo</span>(<span class="kw">map_dbl</span>(<span class="op">!!</span>quo, <span class="op">!!</span>mapper))
}

as_mapper_quosure &lt;-<span class="st"> </span><span class="cf">function</span>(expr) {
  quo &lt;-<span class="st"> </span><span class="kw">enquo</span>(expr)

  rlang<span class="op">::</span><span class="kw">new_function</span>(<span class="kw">alist</span>(<span class="dt">... =</span> , <span class="dt">. =</span> ..<span class="dv">1</span>, <span class="dt">.x =</span> ..<span class="dv">1</span>, <span class="dt">.y =</span> ..<span class="dv">2</span>), <span class="kw">quo_get_expr</span>(quo))
}</code></pre>
<p>We needed to add one more level in the hierarchy of function calling.
The helper function <code>as_mapper_quosure()</code> creates a new function with the help of <code>rlang::new_function()</code>, which eventually makes it possible to leave out the tilde.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as_mapper</span>(<span class="op">~</span><span class="st"> </span><span class="kw">mean</span>(.<span class="op">$</span>Petal.Width))</code></pre>
<pre><code>## &lt;lambda&gt;
## function (..., .x = ..1, .y = ..2, . = ..1) 
## mean(.$Petal.Width)
## &lt;environment: 0x2f0dc30&gt;
## attr(,&quot;class&quot;)
## [1] &quot;rlang_lambda_function&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as_mapper_quosure</span>(<span class="kw">mean</span>(.<span class="op">$</span>Petal.Width))</code></pre>
<pre><code>## function (..., . = ..1, .x = ..1, .y = ..2) 
## mean(.$Petal.Width)
## &lt;environment: 0x97f7c48&gt;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">build_map_quo</span>(mean_petal_width, <span class="kw">mean</span>(.<span class="op">$</span>Petal.Width))</code></pre>
<PRE class="fansi fansi-output"><CODE>## <span style='font-weight: bold;'>&lt;quosure&gt;</span><span>
## expr: </span><span style='color: #0000BB;'>^map_dbl(</span><span style='color: #00BB00;'>^mean_petal_width</span><span style='color: #0000BB;'>, &lt;function(..., . = ..1, .x = ..1,
##           .y = ..2) mean(.$Petal.Width)&gt;)</span><span>
## env:  </span><span style='color: #0000BB;'>0x8e68880</span><span>
</span></CODE></PRE>
<p>We see that our function <code>as_mapper_quosure()</code> is closely related to the function <code>purrr::as_mapper()</code>, but produces a quosure of a proper function and not a lambda function.
Also, it does not require the tilde.</p>
<p>So much to the theory, but does our main function also still behave in the right way?</p>
<pre class="sourceCode r"><code class="sourceCode r">iris <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>Species) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_map_dbl</span>(data, <span class="dt">mean_petal_width =</span> <span class="kw">mean</span>(.<span class="op">$</span>Petal.Width))</code></pre>
<PRE class="fansi fansi-output"><CODE>## <span style='color: #555555;'># A tibble: 3 x 3</span><span>
##   </span><span style='font-weight: bold;'>Species</span><span>    </span><span style='font-weight: bold;'>data</span><span>              </span><span style='font-weight: bold;'>mean_petal_width</span><span>
##   </span><span style='color: #555555;font-style: italic;'>&lt;fct&gt;</span><span>      </span><span style='color: #555555;font-style: italic;'>&lt;list&gt;</span><span>                       </span><span style='color: #555555;font-style: italic;'>&lt;dbl&gt;</span><span>
## </span><span style='color: #555555;'>1</span><span> setosa     </span><span style='color: #555555;'>&lt;tibble [50 × 4]&gt;</span><span>            0.246
## </span><span style='color: #555555;'>2</span><span> versicolor </span><span style='color: #555555;'>&lt;tibble [50 × 4]&gt;</span><span>            1.33 
## </span><span style='color: #555555;'>3</span><span> virginica  </span><span style='color: #555555;'>&lt;tibble [50 × 4]&gt;</span><span>            2.03
</span></CODE></PRE>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="non-rectangular-data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="best-practices.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/krlmlr/tidyprog/edit/master/07-Tidy-evaluation.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": ["tidyprog.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
